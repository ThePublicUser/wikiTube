name: Python YouTube Automation

on:
  schedule:
     - cron: "0 1 * * *"
  workflow_dispatch:  # allow manual runs
jobs:
  run-script:
    runs-on: ubuntu-latest

    env:  
      CLIENT_SECRET_PICKLE_BASE64: ${{ secrets.CLIENT_SECRET_PICKLE_BASE64 }}
      PEXELS_API_KEY: ${{ secrets.PEXELS_API_KEY }}
      PIXABAY_API_KEY: ${{ secrets.PIXABAY_API_KEY }}
      CLIENT_SECRET_JSON: ${{ secrets.CLIENT_SECRET_JSON }}

    steps:
      # ------------------------
      # Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # ------------------------
      # Setup Python
      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: 3.11

      # ------------------------
      # Cache pip packages
      - name: Cache pip
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      # ------------------------
      # Install dependencies using prebuilt wheels
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip wheel setuptools
          pip install --prefer-binary --no-cache-dir -r requirements.txt

      # ------------------------
      # Install FFmpeg
      - name: Install FFmpeg
        run: sudo apt-get update && sudo apt-get install -y ffmpeg

      # ------------------------
      # Decode client secret pickle
      - name: Decode client secret pickle
        run: |
          echo "$CLIENT_SECRET_PICKLE_BASE64" | base64 --decode > client_secret.pickle

      # ------------------------
      # Pre-download Whisper base model
      - name: Pre-download Whisper base model
        run: |
          python -c "import whisper; whisper.load_model('base')"

      # ------------------------
      # Run your main script
      - name: Run main.py
        run: |
          set -e
          python main.py
